{"componentChunkName":"component---src-components-blog-page-layout-blog-page-layout-tsx","path":"/blog-drafts/how-to-use-auth0-together-with-mob-x-","result":{"data":{"mdx":{"id":"e6bc6bdb-baef-55d8-9fec-44a28053e736","body":"function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"How to use Auth0 together with MobX\",\n  \"description\": \"Dont forget to write good description\",\n  \"keywords\": \"sex, drugs, rocknroll\",\n  \"path\": \"/blog/how-to-use-auth0-together-with-mob-x-\",\n  \"date\": \"2020-08-02T00:00:00.000Z\",\n  \"published\": false,\n  \"images\": [{\n    \"author\": \"Max Mustermann\",\n    \"image\": \"./cover.jpg\",\n    \"sourceText\": \"Unsplash\",\n    \"source\": \"https://unsplash.com/@mustermann\",\n    \"is_cover\": 1,\n    \"galleryId\": 0\n  }]\n};\n\nvar makeShortcode = function makeShortcode(name) {\n  return function MDXDefaultShortcode(props) {\n    console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\");\n    return mdx(\"div\", props);\n  };\n};\n\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, [\"components\"]);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"Why Auth0? The service is mature and has a truly generous free plan (...describe).\\nI like when everything is free or almost free (yes, I am a SAAS gypsy).\"), mdx(\"h2\", null, \"Basic stuff, with React npm packages\"), mdx(\"h3\", null, \"Auth\"), mdx(\"h4\", null, \"Provider\"), mdx(\"h4\", null, \"Auth0-to-MobX bridge\"), mdx(\"p\", null, \"I am not a huge fan of \\\"put-all-you-have-into-a-hook-and-use-it\\\". Even though hooks is a great feature by itself, I usually prefer using only basic hooks, and keep my logic somewhere else.\\nIn this case, in MobX state. If you tend to stick to the pure react-way, just skip this part.\"), mdx(\"p\", null, \"So I made a MobX abstraction over Auth0 hooks, called \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"auth-state\"), \". It helps also to hide all the complexity of Auth0 response behind a rather simple abstraction.\"), mdx(\"h3\", null, \"AuthWidget\"), mdx(\"h2\", null, \"RBAC and \\\"protected\\\" routes\"), mdx(\"p\", null, \"I could have had \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"RBAC\"), \" on my backend side, but it is quite expensive (or time consuming) to make. Instead, I decided to check out what Auth0 has to offer.\"), mdx(\"p\", null, \"Up to this point everything was smooth... except that I needed to know roles client-side to enable the \\\"protected routes\\\" feature in my SPA.\\nRoles are \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://auth0.com/docs/api/authentication#get-user-info\"\n  }), \"not included into the user object\"), \", and there is no way to get it unless I call \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://auth0.com/docs/api/management/v2#!/Users/get_user_roles\"\n  }), \"the management api\"), \".\\nTo call this API I apparently need a special kind of management token, which is not possible to get from the client side (without knowing the app secret).\"), mdx(\"p\", null, \"It is funny to notice once in a while, how a tiny misconception is able ruin great overall experience and make you bump against a wall for a couple of hours =( For an SPA there is an obvious urge to have roles accessible via a \\\"user\\\"-type token! That is where I felt like stuck and depressed.\"), mdx(\"p\", null, \"Then I came across the \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://auth0.com/docs/extensions/authorization-extension/v2\"\n  }), \"extensions\")), mdx(\"p\", null, mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://manage.auth0.com/dashboard/eu/gannochenko/extensions\"\n  }), \"https://manage.auth0.com/dashboard/eu/gannochenko/extensions\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js\"\n  }), \"try {\\n    // load metadata\\n    const accessToken = await this.getAccessTokenMethod!({\\n        audience: `https://${this.domain}/api/v2/`,\\n        scope: 'read:current_user',\\n    });\\n\\n    const userDetailsByIdUrl = `https://${this.domain}/api/v2/users/${user.sub}`;\\n\\n    const metadataResponse = await fetch(userDetailsByIdUrl, {\\n        headers: {\\n            Authorization: `Bearer ${accessToken}`,\\n        },\\n    });\\n\\n    const data = await metadataResponse.json();\\n    const roles = data.app_metadata.authorization.roles as string[];\\n\\n    // ...\\n} catch (error) {\\n    console.error(error);\\n}\\n\")), mdx(\"p\", null, \"This solution solves the case, yet it is far from ideal: I have to re-get user info, and that is +1 query that delays the first meaningful data paint.\"), mdx(\"p\", null, \"I want my app work faster, that is why I have decided to put roles into a token itself. To do that, I create another rule AFTER the Auth Extension rule:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js\"\n  }), \"function (user, context, callback) {\\n    var namespace = 'http://auth0-test/claims/'; // You can set your own namespace, but do not use an Auth0 domain\\n    \\n    // Add the namespaced tokens. Remove any which is not necessary for your scenario\\n    context.idToken[namespace + \\\"permissions\\\"] = user.permissions;\\n    context.idToken[namespace + \\\"groups\\\"] = user.groups;\\n    context.idToken[namespace + \\\"roles\\\"] = user.roles;\\n    \\n    callback(null, user, context);\\n}\\n\")), mdx(\"p\", null, \"The value of the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"namespace\"), \" should be of format \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"http://your-domain/claims/\"), \", otherwise the thing does not work. This is weird, not to say the least, but it eventually the roles get available via the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"http://auth0-test/claims/roles\"), \" key in the user object.\"), mdx(\"p\", null, \"This solution is not ideal too: in case if I update a user, they will have to re-login to make effect. In my case it is not crucial since I seldom update my users.\"), mdx(\"p\", null, \"If you update users often, then on each update you need to invalidate all the tokens. Plus, you will have to make that extra query all the time.\"), mdx(\"h2\", null, \"Protected route component\"), mdx(\"h2\", null, \"Backend part\"), mdx(\"p\", null, \"The backend part is no less complex than the front, but not without nuances.\"), mdx(\"p\", null, \"First of all, it worth to mention, that it is totally doable to \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://auth0.com/docs/quickstart/webapp/nodejs\"\n  }), \"implement the signup, signin and user profile endpoints on the side of your API\"), \". However, as I don't want that complexity in the first place, tha case is not mine, since I consume the Auth0 API directly.\"), mdx(\"p\", null, \"The next thing is: if you don't rely on what is inside of the token you receive, you have to make an additional query to get the user's data. So this would be +1 remote call per each endpoint hit.\"), mdx(\"p\", null, \"What you can do, however, is to cache the user data to Redis and get it from here instead of doing a remote call. Unfortunately, then you would be forced to add a special hook on the Auth0 side, so whenever you update a user, your cache gets busted.\\nSince yours and Auth0 infrastructures do not share any common trusted Virtual Network (like a microservice grid typically does), you will have to expose an endpoint.\\nTo secure the endpoint you would have to come up with some sort of a token. The token needs to be rotated on a regular basis. Instead of a token-based system, a SSH tunnel can be established, but I possess no information regarding solid support for that on the Auth0 side.\"), mdx(\"p\", null, \"Anyways, lots of trouble!\"), mdx(\"p\", null, \"My case is simpler, since I 100% rely on the token payload, I just need to find a way to 1. check if the token is valid, 2. deserialize the token payload, 3. check if a user has permissions for each particular case in the app.\"), mdx(\"h2\", null, \"Terraform\"), mdx(\"p\", null, \"If you don't use protected routes, then you don't need to pull roles client-side. In this case installation of Auth Extension is not required, and you can keep roles and operation on the Auth0 side.\\nIf that is your case, you can make use of \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://www.terraform.io/docs/providers/auth0/index.html\"\n  }), \"the official Auth0 provider\"), \" and do everything you need to do.\"), mdx(\"p\", null, \"Otherwise, bad news for you: \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://github.com/alexkappa/terraform-provider-auth0/issues/85\"\n  }), \"Auth Extension can not be terraformed\"), \" (at least not yet) :(\"), mdx(\"h2\", null, \"Hooks\"), mdx(\"p\", null, \"In case if you live in a country where paranoid government forbids keeping user personal data outside of the great iron curtain, we will have to manage profiles on our own...\"), mdx(\"p\", null, \"We need to prevent saving first and last names on the Auth0 side. To do this, we can make use of hooks.\"), mdx(\"p\", null, mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://auth0.com/docs/hooks/extensibility-points/pre-user-registration\"\n  }), \"https://auth0.com/docs/hooks/extensibility-points/pre-user-registration\")), mdx(\"p\", null, \"What a pleasant surprise, it is in JavaScript.\"));\n}\n;\nMDXContent.isMDXComponent = true;","frontmatter":{"title":"How to use Auth0 together with MobX","date":"2020-08-02T00:00:00.000Z","keywords":"sex, drugs, rocknroll","description":"Dont forget to write good description","published":false,"images":[{"image":{"childImageSharp":{"fluid":{"tracedSVG":"data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20width='400'%20height='267'%20viewBox='0%200%20400%20267'%20preserveAspectRatio='none'%3e%3cpath%20d='M0%20109c0%2098%200%20108%202%20108l3-1c1%200%201-1-1-1-2-1-2-1%201-1l3%201h4l7%201a885%20885%200%200172%207h4v5l-3%208c-4%208-4%209%203%2010%203%200%205%200%204-1l-2-1c3-6%205-8%206-8%202-1%201%204-1%206-4%203-2%204%2015%206%2014%202%2018%202%2041%202a207%20207%200%200155%202h5l-2%201c-1%201%200%201%203%201l10%201%2024%202c5%200%207%200%205%201s-2%201%201%201a483%20483%200%200131%201l-1-1c1-1-2-2-11-2l-14-2h-8c1%201%201%201-1%201-3%200-3%200-2-1s1-1-1-1h-3l-2-1a331%20331%200%2001-26-1c1-2%201-2-4-2l-5-1%2012-1a67%2067%200%200020-2l6-1h-7l-7-1c1-1-2-3-6-3l-3-1c0-1%201-2%203-2l3-1%202-2%202%201c-2%202%2014%203%2020%201%202%200%202%200%200-1-1-1%200-1%203-1h5l-18-1c-20-1-26-2-20-3h3l3%201v-1c-3-1-1-2%205-2h7l-6-2-11-1h-5a137%20137%200%200131-1c-1-1%201-1%203-1%206%200%208-1%207-2l-2-1c-2%200-1-1%201-1l4-1h-4a373%20373%200%2000-22-2c0-2%204-3%2030-3a321%20321%200%2000-38-2h-6l6-2h29c9%201%2034%201%2033-1l-15-1-14-1h11l13-1-8-1-18-1%204-1c4-1%204-1-1-1-4%200-6%200-6%202h-8l-12%201c-1%201-1%200-1-1l-2-1c-6%202-14%201-14%200l4-1c2-1%202-1-3-1l-9-1c-2-1-1-1%204-1h7l4-2c4%200%204%200%202-1h-7l-2%201-4%201c-4%200-4%200-1-1%202%200%203%200%202-1s-1-1%201-2%202-1%200-1l-3%201c-1%202-9%201-11%200-1-2-5-2-6-1h-5c-3%200-5-1-5-3%201-2%2013-4%2015-2h4c3-1%202-1-2-1-2-1-4-2-2-2l1-2h1l2-1h5l2-1%201%201%202%201%201-1h2l5-1-12-3-8-1a177%20177%200%2000-31-5l2-1%202-1%204-2c7-2%2011-3%209-4v-1h1l2%201-1-4c-1-4-3-3%2020-3l16-1-20-1c-25-2-30-2-33-4l-9-1c-6%201-7-1-3-4%202-2%202-2%20132-1h64c5-1%2020%200%2032%202%204%200%206%203%203%203-2%200-2%207%200%208l1%206c0%205%200%206-2%206l-2%201%201%201c2%200%201%203-1%204-3%200-2%202%201%203%202%201%203%201%203%209s0%209-2%2011v1c2%200%203%202%201%204v1c2%201%201%206%200%207a890%20890%200%20002-105V0h-7c-7%200-8%200-5%204v2l-1%201%202%201%202%201%202%201c2%200%205%205%203%206-1%201-1%201%201%203l2%202v89h-34l-7-7-10-8-4-2-10-8-11-7-4-3c-5-2-13-8-15-12l-7-6-7-4-5-3-1-1-3-2-5-4-8-5-8-4-3-2a74%2074%200%2001-32-26l-5-6H0v109m127-49l2%204v4l1%204v1c-2%201%200%2010%203%2012l3%202v-7l-2-8-1-5-1-4-1-2c1-2-1-4-3-4l-1%203m102%209c15%2029%2019%2034%2022%2034%202%200%202%200%200-1l-1-2-1-3-1-4c0-2%205%203%207%208%202%204%204%205%203%202l1-3c2-1%201-3%200-2l-2-1-2-1-2-3-2-4v-4c1-2%201-2-1-3s-3%200-3%202-1%202-2%201l-1-3h-2l-1-4-5-5c-2%200-6-6-6-7l-1-2-1-1-1-2c-1%200-1%202%202%208m-95%2021v2l3%202%202%201c2-1%206%203%206%205h-2c-4-3-6-2-6%200l2%206c0%205%202%206%203%204%201-1%202-2%203-1%202%200%202%200%201-1v-5c-1-1%200-2%201-3l2-2-2-1-3-3-2-3c-3-2-5-3-4-1h-4m19%2034c-3%201-8%206-8%207l-1%203c-2%202-3%208-2%208l1-1c0-3%201%200%202%204%200%202%200%203-2%204-2%200-4%205-4%206%201%200%200%202-2%203-2%203-3%205%200%203%203-3%2016-5%2017-3%201%201-7%203-14%205-4%200-4%200-2%201l8%201c10%200%2010%202-1%202l-11%201c-1-1-4%207-3%208l-1%202v2l-1%204c-1%203-1%203%204%201l5-2c3%200-7%205-9%205l-2%201c0%203%2020-5%2021-8l3-1%204-1c1-1%200-1-3-1h-6c-1-1-1-1%202-1l6-2c2-1%202-1-2-1-8%201-4-2%204-2l9-2c2%200%203%200%205%202l2%202v-3c0-2%200-2%202-2l1-1c0-1-3-2-3%200-1%201-6-4-8-8l-2-3c-1%200-11-10-11-12l-2-4-2-2h2c3%200%204-2%201-3-2%200-2-1-2-4s0-4%201-2c0%204%2010%208%209%204l1-2%206-5c0-2-10-4-12-3m-19%2019l-31%202c-6%200-7%200-7%202s0%202%2016%202l9%201-17%2023c-6%208-8%2011-9%2016%200%204%200%204%201%203l2-2%203-2v-3c-1%200%202-6%205-9%202-2%200%204-2%206v2c1%201%204-3%204-5l3-2c2%200%203-1%203-2-2-2%204-11%206-9%201%202-5%2016-8%2018l-3%203c0%203-1%205-3%205-2-1-3%202-1%204l1%203v2l8-13c6-13%2012-21%2015-20l6-9a162%20162%200%20017-15l-8-1m10%2046l-11%207c-3%201-2-1%201-3%203-3%202-3-1-2-4%201-9%2013-6%2013l1-1%202-1%202%201c-1%200%200%202%202%202%202%202%203%202%2010-4%205-4%2010-6%2014-7%2010-3%2010-5%201-4l-9%203-8%206-7%203h-2c-1-1-1-1%201-2l2-1%205-4c4-2%205-3%205-5s-1-3-2-1m24%2012c-6%203-10%206-8%206l-3%203-4%203-4%203c-6%204-3%204%204%200l8-3c1%200%204-2%206-5%209-9%209-11%201-7m-14-1l-4%201c-2%200-2%200-1%201%201%202%201%202-1%203-3%200-4%202-2%202%201%201%201%201%200%200l-2%201c0%201-7%205-10%205-4%201-6%205-3%205h2l1-1%201%202h2l8-4c5-2%2010-6%2010-8l2-1%201-2h-2c-3%202-6%203-6%201l1-1%204-2%201-3-2%201m139%2018l-21%202c-4%200-5%200-5%202l-1%201%202%201h11c6-1%207-1%202-1-11%200-3-2%2014-3l14-1-16-1m-143%203v2c1%201%200%201-1%201l-6%201-1-1h-3c-1%202-1%202%201%202%203%200%203%202%200%203-3%202-4%201-4-2v-1l-5%203-4%201c0%202%209%204%2012%203%205-1%2019-10%2017-12%200-2-6-1-6%200m35%2011l-1%205v3c0%203%201%203%203%203h2l4%202c5%201%203-4-3-7-3-2-4-4-1-4%204%201%2034-1%2033-2l-5-1h-4l4-1-8-1h-19l-6-1%201%204m200-3l7%202%207%201-2%201c-3-1-3%200-3%201%200%202%200%203-2%203h-2l2%202%203%201h-3c-2%200-2%200-1%202%201%201%201%201-1%201-3%200-4%202-1%204v2l-4%202c-2%200-1%202%201%202s2%200%201%201h-3l-6%201-4%201h4c7%200%207%202-1%202s-7%202%200%202l4%201%202%201c1%201-2%201-5%201-5%200-7%200-5%201%203%201%201%202-4%202l13%201h18v-37l-15-1'%20fill='%23d3d3d3'%20fill-rule='evenodd'/%3e%3c/svg%3e","aspectRatio":1.497584541062802,"src":"/static/0174b271c0ea450f9eaaa6920322ef53/77467/cover.jpg","srcSet":"/static/0174b271c0ea450f9eaaa6920322ef53/dece2/cover.jpg 310w,\n/static/0174b271c0ea450f9eaaa6920322ef53/fcb16/cover.jpg 620w,\n/static/0174b271c0ea450f9eaaa6920322ef53/77467/cover.jpg 1240w,\n/static/0174b271c0ea450f9eaaa6920322ef53/b1020/cover.jpg 1860w,\n/static/0174b271c0ea450f9eaaa6920322ef53/88564/cover.jpg 2480w,\n/static/0174b271c0ea450f9eaaa6920322ef53/9df58/cover.jpg 6000w","sizes":"(max-width: 1240px) 100vw, 1240px"}}},"author":"Max Mustermann","source":"https://unsplash.com/@mustermann","sourceText":"Unsplash","is_cover":1,"galleryId":0}]}}},"pageContext":{"id":"e6bc6bdb-baef-55d8-9fec-44a28053e736"}}}